name: Build & Release Rust Project

on:
    workflow_dispatch:

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                include:
                    - os: ubuntu-latest
                      targets:
                          [
                          		i686-unknown-linux-gnu,
                              x86_64-unknown-linux-gnu,
                          ]
                    - os: windows-latest
                      targets:
                          [
                              i686-pc-windows-msvc,
                              x86_64-pc-windows-msvc,
                              aarch64-pc-windows-msvc,
                          ]
                    - os: macos-latest
                      targets: [aarch64-apple-darwin]

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Read version
              id: get_version
              shell: bash
              run: |
                  VERSION=$(cat version.txt | tr -d " \n\r")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Set up Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
                  profile: minimal
                  override: true

            - name: Install 32-bit and aarch64 Linux deps
              if: matrix.os == 'ubuntu-latest'
              shell: bash
              run: |
                  sudo dpkg --add-architecture i386
                  sudo apt update
                  sudo apt install -y gcc-multilib g++-multilib libc6-dev-i386

            - name: Install Rust targets
              shell: bash
              run: |
                  for t in ${{ join(matrix.targets, ' ') }}; do
                    rustup target add $t
                  done

            - name: Build targets
              shell: bash
              run: |
                  for t in ${{ join(matrix.targets, ' ') }}; do
                    cargo build --release --target $t
                  done

            - name: Package artifacts
              shell: bash
              run: |
                  mkdir -p dist
                  BIN_NAME=ran
                  for t in ${{ join(matrix.targets, ' ') }}; do
                    case "$t" in
                      *windows-msvc)
                        BIN="${BIN_NAME}.exe"
                        case "$t" in
                          i686-pc-windows-msvc) ARCH="windows_x86" ;;
                          x86_64-pc-windows-msvc) ARCH="windows_x86_64" ;;
                          aarch64-pc-windows-msvc) ARCH="windows_aarch64" ;;
                        esac
                        zip -j dist/${ARCH}.zip target/$t/release/$BIN
                        ;;
                      *unknown-linux-gnu)
                        BIN="$BIN_NAME"
                        case "$t" in
                          i686-unknown-linux-gnu) ARCH="linux_x86" ;;
                          x86_64-unknown-linux-gnu) ARCH="linux_x86_64" ;;
                          aarch64-unknown-linux-gnu) ARCH="linux_aarch64" ;;
                        esac
                        tar -czf dist/${ARCH}.tar.gz -C target/$t/release $BIN
                        ;;
                      *apple-darwin)
                        BIN="$BIN_NAME"
                        ARCH="macos_aarch64"
                        mkdir -p dmgroot
                        cp target/$t/release/$BIN dmgroot/
                        hdiutil create dist/${ARCH}.dmg -fs HFS+ -srcfolder dmgroot
                        ;;
                    esac
                  done

            - name: Upload artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: release-artifacts
                  path: dist/*

    release:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Read version
              id: get_version
              run: |
                  VERSION=$(cat version.txt | tr -d " \n\r")
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Download build artifacts
              uses: actions/download-artifact@v7
              with:
                  name: release-artifacts
                  path: dist

            - name: Create GitHub Release
              id: create_release
              uses: ncipollo/release-action@v1
              with:
                  tag: ${{ steps.get_version.outputs.version }}
                  release_name: ${{ steps.get_version.outputs.version }}
                  bodyFile: changelog.md
                  draft: true
                  prerelease: false
                  artifacts: "dist/*"
